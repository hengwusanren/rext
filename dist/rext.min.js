!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.rexter=t()}(this,function(){"use strict";Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null==this)throw new TypeError("this is null or not defined");var r=Object(this),o=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(t=arguments[1]),n=0;n<o;){var a;n in r&&(a=r[n],e.call(t,a,n,r)),n++}});var e,t=function(){return 1e4*(new Date).getTime()+Math.floor(1e4*Math.random())},n=(e=0,function(){return e++}),r=function(e){return"number"==typeof e},o=function(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)},a=function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=function(e){return null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"function"==typeof e},i=function(e,t,n){if(o(e))for(var r in e){if(e.hasOwnProperty(r))if(!1===t(e[r],r))break}else if(a(e))if(n)for(s=e.length-1;s>=0;s--){if(!1===t(e[s],s))break}else for(var s=0,i=e.length;s<i;s++){if(!1===t(e[s],s))break}else c=e.forEach,"function"==typeof c&&e.forEach(t);var c},c=function(e){var t=e;return o(e)?(t={},i(e,function(e,n){t[n]=c(e)})):a(e)&&(t=[],i(e,function(e){t.push(c(e))})),t},u=function(e,t){if(o(e))return e.hasOwnProperty(t);if(a(e)){var n=parseInt(t);return r=t,s=parseInt(r),!isNaN(s)&&("number"==typeof r||"string"==typeof r)&&s==r&&e.length>n&&n>=0}var r,s;return!1},l=function(e,t,n){var s="string"==typeof t||r(t),c=s?e[t]:e;(o(c)||a(c))&&(i(c,function(e,t){l(c,t)}),a(c)&&p(c)),s&&(e[t]=n)},p=function(e,t){if(r(t))for(i(e,function(n,r){if(!(r>=t))return!1;e.length--},!0);e.length<t;)e.push(null);else i(e,function(t,n){t===undefined&&e.length--},!0);return e},f=function(e,t,n){if(!o(e))return null;var r=Array.prototype.slice.call(arguments,1,!0===arguments[arguments.length-1]?arguments.length-1:arguments.length);return n=!0===arguments[arguments.length-1],i(r,function(t){!function r(e,t,n){o(t)&&(i(t,function(t,o){!u(e,o)||s(t)?e[o]!==t&&(e[o]=c(t)):r(e[o],t,n)}),n&&(i(e,function(n,r){u(t,r)||l(e,r)}),a(e)&&p(e)))}(e,t,n)}),e},d=function(e){if(null==e)return"";if("array"===function(e){if(null===e)return"null";if(e===undefined)return"undefined";var t=Object.prototype.toString.call(e);return t.substring("[object ".length,t.length-1).toLowerCase()}(e))return JSON.stringify(e);if(s(e))return String(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(s(e[n])?String(e[n]):JSON.stringify(e[n])));return t.join("&")};function y(e){return"/"===e.charAt(0)&&(e="/"===e.charAt(1)?window.location.protocol+e:window.location.protocol+"//"+window.location.host+e),e}function h(e,t){return function(n){var r=e[t];return e[t]=function(){var e=[].slice.call(arguments);r&&r.apply(this,e),n&&n.apply(this,e)},this}}function w(e){return function(t){var n=e.apply(null,arguments);return t.promise?new(0,t.promise)(function(e,t){n.success(function(t){e(t)}),n.error(function(e){t(e)})}):n}}function g(){try{return new window.XMLHttpRequest}catch(e){}}var m=window.ActiveXObject===undefined||window.document.documentMode>8?g:function(){return g()||function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}()},v={},T={type:"GET",url:null,data:{},headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},responseType:"text",withCredentials:!1};var x=w(function(e){var t=f({},T,e||{});e.simple&&("X-Requested-With"in e.headers||delete t.headers["X-Requested-With"]);var r=n(),o={success:e.success||arguments[1]||function(){},error:e.error||arguments[2]||function(){},always:e.always||arguments[3]||function(){}},a=m(),s=function(e,n){if(null!=s&&(4===a.readyState||n))if(delete v[r],s=undefined,a.onreadystatechange=null,n)4!==a.readyState&&a.abort();else{var i=function(e,t){var n;if("blob"===t)return"function"==typeof Blob?e.response:e.responseText;if("responseType"in e&&"text"!==e.responseType&&""!==e.responseType)return e.response;try{n=JSON.parse(e.responseText)}catch(r){n=e.responseText}return n}(a,t.responseType),c={status:a.status,statusText:a.statusText,responseText:a.responseText,readyState:a.readyState};a.status>=200&&a.status<300?o.success.call(o,i,c):o.error.call(o,i,c),o.always.call(o,i,c)}},i="string"==typeof t.type&&"get"!==t.type.toLowerCase(),c=!i&&/multipart\/form-data/i.test(t.headers["Content-Type"])?t.data:d(t.data);if(a.open(t.type,i||!c?t.url:t.url+(t.url.indexOf("?")>0?"&":"?")+c,!0),a.overrideMimeType)switch(t.responseType){case"document":case"xml":a.overrideMimeType("text/xml; charset=utf-8");break;case"text":a.overrideMimeType("text/plain; charset=utf-8");break;case"blob":a.overrideMimeType("text/plain; charset=x-user-defined")}for(var u in t.headers)t.headers.hasOwnProperty(u)&&a.setRequestHeader(u,t.headers[u]);return/^\d+$/.test(e.timeout)&&(a.timeout=e.timeout,a.ontimeout=s),t.withCredentials&&(a.withCredentials=!0),i?a.send(/application\/json/i.test(t.headers["Content-Type"])?JSON.stringify(t.data):c):a.send(""),4===a.readyState?window.setTimeout(s):a.onreadystatechange=v[r]=s,{success:h(o,"success"),error:h(o,"error"),always:h(o,"always"),abort:function(){s&&s(undefined,!0)}}});window.attachEvent&&window.attachEvent("onunload",function(){for(var e in v)v.hasOwnProperty(e)&&v[e](undefined,!0)});var b=m(),C=!!b&&"withCredentials"in b,j=/^(https?:)?\/\//i,O=/^get|post$/i,E=new RegExp("^(//|"+window.location.protocol+")","i"),S={type:"GET",url:null,data:{},responseType:"text"};var L=w(function(e){if(e=f({},S,e||{}),O.test(e.type)&&j.test(e.url)&&E.test(e.url)){var t=(e.responseType||"json").toLowerCase(),n=new XDomainRequest;/^\d+$/.test(e.timeout)&&(n.timeout=e.timeout);var r={success:e.success||function(){},error:e.error||function(){},always:e.always||function(){}};n.ontimeout=function(){var e={status:{code:500,message:"timeout"}};r.error.call(r,null,e),r.always.call(r,null,e)},n.onprogress=function(){},n.onload=function(){var e={code:200,message:"success"},o={headers:{"Content-Length":n.responseText.length,"Content-Type":n.contentType},text:n.responseText,data:function(e){var t;try{t=JSON.parse(e)}catch(n){t=e}return t}(n.responseText)};if("html"===t||/text\/html/i.test(n.contentType))o.data=n.responseText;else if("json"===t||"text"!==t&&/\/json/i.test(n.contentType))try{o.data=JSON.parse(n.responseText)}catch(s){e.code=500,e.message="parser error: invalid json"}else if("xml"===t||"text"!==t&&/\/xml/i.test(n.contentType)){var a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";try{a.loadXML(n.responseText)}catch(s){a=undefined}a&&a.documentElement&&!a.getElementsByTagName("parsererror").length||(e.code=500,e.message="parser error: invalid xml"),o.data=a}o.status=e,e.code>=200&&e.code<300?r.success.call(r,o.data,o):r.error.call(r,o.data,o),r.always.call(r,o.data,o)},n.onerror=function(){var e=[n.responseText,{status:{code:500,message:"error"},text:n.responseText}];r.error.apply(r,e),r.always.apply(r,e)};var o="string"==typeof e.type&&"get"!==e.type.toLowerCase(),a=d(e.data);return n.open(e.type,o||!a?e.url:e.url+(e.url.indexOf("?")>0?"&":"?")+a),window.setTimeout(function(){n.send(o?a:"")},0),{success:h(r,"success"),error:h(r,"error"),always:h(r,"always"),abort:function(){n.abort()}}}}),M=!!window.XDomainRequest;var k=w(function(e,n){var r="jsonp_"+t();window[r]=n||e.callback||e.complete;var o=window.document.getElementsByTagName("script")[0],a=window.document.createElement("script");a.src=e.url+(e.url.indexOf("?")>=0?"&":"?")+d(e.data)+"&callback="+r,o.parentNode.insertBefore(a,o),a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState)){a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),a=null,window[r]=undefined;try{delete window[r]}catch(e){}}};var s=h(window,r);return{success:s,complete:s,error:function(){}}});var N,q,X,A={},P={},R={},J={},B={};function I(e){return"iframe-agent-"+(A[n=e]===undefined&&(A[n]=t()),A[n]);var n}function U(e){var t=I(e),n=window.document.getElementById(t);n||((n=window.document.createElement("iframe")).id=t,n.style.display="none",window.document.body.appendChild(n));var r,o=(R[r=e]===undefined&&(R[r]=r+"/iframe-agent.html"),R[r]);return n.src!==o&&(n.src=o),n}N="message",q=function(e){var t;try{t=JSON.parse(e.data)}catch(r){}if(t)switch(t.type){case"iframe-agent-ready":J[t.origin]=!0;var n=window.document.getElementById(I(t.origin));B[t.origin]&&(B[t.origin].forEach(function(e){n.contentWindow.postMessage(e,t.origin)}),B[t.origin].length=0),delete B[t.origin];break;case"iframe-agent-response":null!=t.id&&P[t.origin][t.id]&&("success"===t.message?P[t.origin][t.id].success.apply(null,t.data):"error"===t.message&&P[t.origin][t.id].error.apply(null,t.data),P[t.origin][t.id].always&&P[t.origin][t.id].always.apply(null,t.data),delete P[t.origin][t.id])}},X=X||window,window.addEventListener?X.addEventListener(N,q,!1):X.attachEvent("on"+N,q);var $,W=w(function(e){e.url=y(e.url);var n=e.url.toString().replace(/^(.*\/\/[^\/?#]*).*$/,"$1");e.agentPageUrl&&(e.agentPageUrl=y(e.agentPageUrl),R[n]=e.agentPageUrl);var r={success:e.success||arguments[1]||function(){},error:e.error||arguments[2]||function(){},always:e.always||arguments[3]||function(){}},o=t();P[n]||(P[n]={}),P[n][o]=r;var a,s,i,c=U(n);return s=c,i={type:"iframe-agent-request",origin:a=n,id:o,data:e},J[a]?s.contentWindow.postMessage(JSON.stringify(i),a):(B[a]||(B[a]=[]),B[a].push(JSON.stringify(i))),{success:h(r,"success"),error:h(r,"error"),always:h(r,"always")}}),D=function(e,t,n){("undefined"==typeof process?setTimeout:process.nextTick)(1===arguments.length?e:function(){e.apply(n,t instanceof Array?t:[t])})},H=function(e){return"function"==typeof e},_=function(e){return"object"==typeof e&&null!==e},F=function(e,t){if(e===t)z(e,2,new TypeError("The promise and its value refer to the same object."));else if(t&&t.constructor===K)0===t.state?t.then(function(t){F(e,t)},function(t){z(e,2,t)}):z(e,t.state,t.value);else if(_(t)||H(t)){var n=!1;try{var r=t.then;H(r)?r.call(t,function(t){n||(F(e,t),n=!0)},function(t){n||(z(e,2,t),n=!0)}):(z(e,1,t),n=!0)}catch(o){n||(z(e,2,o),n=!0)}}else z(e,1,t)},G=function(e,t,n){if(0!==t&&e.callbacks[t]){var r;try{r=e.callbacks[t].call(undefined,n)}catch(o){return void z(e,2,o)}F(e,r)}else 1!==t||e.callbacks[1]?2!==t||e.callbacks[2]||z(e,2,n):F(e,n)},z=function(e,t,n){0===e.state&&0!==t&&(e.state=t,e.value=n,D(function(){for(;e.queue.length;)G(e.queue.shift(),e.state,e.value)}))},K=function(e){if(this.state=0,this.value=null,this.queue=[],this.callbacks={},H(e)){var t=this;e(function(e){F(t,e)},function(e){z(t,2,e)})}};K.prototype.then=function(e,t){var n=new K;return n.callbacks[1]=H(e)&&e,n.callbacks[2]=H(t)&&t,0===this.state?this.queue.push(n):D(G,[n,this.state,this.value]),n},K.prototype.resolve=function(e){return F(this,e),this},K.prototype.reject=function(e){return z(this,2,e),this},($=K).prototype["catch"]=function(e){return this.then(undefined,e)},$.prototype.done=function(e,t){(arguments.length?this.then.apply(this,arguments):this).then(undefined,function(e){D(function(){throw e})})},$.prototype["finally"]=function(e){return H(e)?(e=function(t){return $.resolve(e()).then(function(){return t})},this.then(e,e)):this},$.resolved=$.resolve=function(e){return new $(function(t){t(e)})},$.rejected=$.reject=function(e){return new $(function(t,n){n(e)})},$.deferred=function(){var e,t;return{promise:new $(function(n,r){e=n,t=r}),resolve:e,reject:t}},$.all=function(e){var t=Array.prototype.slice.call(e);return new $(function(e,n){if(0===t.length)return e([]);for(var r=t.length,o=t.length,a=0;a<r;a++)$.resolved(t[a]).then(function(n){t[a]=n,0==--o&&e(t)},n)})},$.race=function(e){var t=Array.prototype.slice.call(e);return new $(function(e,n){if(0===t.length)return e(null);for(var r=0,o=t.length;r<o;r++)$.resolve(t[r]).then(e,n)})};var Q=K;function V(e){var n=[].slice.call(arguments);if(!1!==e.promise&&(e.promise=V.defaults.promise),"string"==typeof e.dataType&&(e.dataType=e.dataType.toLowerCase()),"string"==typeof e.responseType&&(e.responseType=e.responseType.toLowerCase()),"string"==typeof e.method&&(e.method=e.method.toLowerCase()),"string"==typeof e.type&&(e.type=e.type.toLowerCase()),!!e.jsonp||"jsonp"===e.dataType||"jsonp"===e.responseType)return k.apply(null,n);var r=function(e){e=y(e);var t=/^([\w.+-]+:)?(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=t.exec(window.location.href.toLowerCase())||[],r=t.exec(e.toLowerCase());return r[1]===undefined&&(r[1]=n[1]),!(!r||r[1]===n[1]&&r[2]===n[2]&&(r[3]||("http:"===r[1]?"80":"443"))===(n[3]||("http:"===n[1]?"80":"443")))}(e.url),a=!!e.withCredentials||e.xhrFields&&!!e.xhrFields.withCredentials;e.withCredentials=a,e.type||"string"!=typeof e.method||(e.type=e.method),"string"!=typeof e.type&&(e.type="get"),e.type=e.type.toLowerCase();var s="get"!==e.type;!1!==e.cache&&(e.cache=!0),e.cache||s||!o(e.data)||(e.data._=t()),e.headers||(e.headers={}),e.contentType&&(e.headers["Content-Type"]?delete e.contentType:e.headers["Content-Type"]=e.contentType),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"string"!=typeof e.responseType&&("string"==typeof e.dataType&&/^(text|json|xml|html)$/i.test(e.dataType)?e.responseType=e.dataType:e.responseType="text"),e.complete&&(e.always=e.complete,delete e.complete);var i=!!e.agent;return!r||C&&!i?x.apply(null,n):i||!M||a||s||/\/json/i.test(e.headers["Content-Type"])?W.apply(null,n):L.apply(null,n)}return V.defaults={},window.rext_promises_aplus=Q,"undefined"==typeof Promise?V.defaults.promise=Q:V.defaults.promise=Promise,V});
