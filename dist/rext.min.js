!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.rexter=t()}(this,function(){"use strict";function e(e){return"/"===e.charAt(0)&&(e="/"===e.charAt(1)?window.location.protocol+e:window.location.protocol+"//"+window.location.host+e),e}function t(t){t=e(t);var n=/^([\w.+-]+:)?(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,r=n.exec(window.location.href.toLowerCase())||[],o=n.exec(t.toLowerCase());return o[1]===undefined&&(o[1]=r[1]),!(!o||o[1]===r[1]&&o[2]===r[2]&&(o[3]||("http:"===o[1]?"80":"443"))===(r[3]||("http:"===r[1]?"80":"443")))}function n(e,t){return function(n){var r=e[t];return e[t]=function(){var e=[].slice.call(arguments);r&&r.apply(this,e),n&&n.apply(this,e)},this}}function r(e,t){this.promise=new e(t)}function o(e){return function(t){var n=[].slice.call(arguments),o=e.apply(null,n);return t.promise?new r(t.promise,function(e,t){o.success(function(t){e(t)}),o.error(function(e){t(e)})}):o}}function a(){try{return new window.XMLHttpRequest}catch(e){}}function s(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}function i(e,t){var n;if("blob"===t)return"function"==typeof Blob?e.response:e.responseText;if("responseType"in e&&"text"!==e.responseType&&""!==e.responseType)return e.response;try{n=JSON.parse(e.responseText)}catch(r){n=e.responseText}return n}function c(e){var t;try{t=JSON.parse(e)}catch(n){t=e}return t}function u(e){return e.toString().replace(/^(.*\/\/[^\/?#]*).*$/,"$1")}function l(e){return G[e]===undefined&&(G[e]=w()),G[e]}function p(e){return z[e]===undefined&&(z[e]=e+"/iframe-agent.html"),z[e]}function d(e){return"iframe-agent-"+l(e)}function f(e){var t=d(e),n=window.document.getElementById(t);n||((n=window.document.createElement("iframe")).id=t,n.style.display="none",window.document.body.appendChild(n));var r=p(e);return n.src!==r&&(n.src=r),n}function y(e,t,n,r){var o={type:"iframe-agent-request",origin:e,id:n,data:r};K[e]?t.contentWindow.postMessage(JSON.stringify(o),e):(Q[e]||(Q[e]=[]),Q[e].push(JSON.stringify(o)))}function h(e){var n=[].slice.call(arguments);if(e.promise&&"function"!=typeof e.promise&&(e.promise=h.defaults.promise),"string"==typeof e.dataType&&(e.dataType=e.dataType.toLowerCase()),"string"==typeof e.responseType&&(e.responseType=e.responseType.toLowerCase()),"string"==typeof e.method&&(e.method=e.method.toLowerCase()),"string"==typeof e.type&&(e.type=e.type.toLowerCase()),!!e.jsonp||"jsonp"===e.dataType||"jsonp"===e.responseType)return F.apply(null,n);var r=t(e.url),o=!!e.withCredentials||e.xhrFields&&!!e.xhrFields.withCredentials;e.withCredentials=o,e.type||"string"!=typeof e.method||(e.type=e.method),"string"!=typeof e.type&&(e.type="get"),e.type=e.type.toLowerCase();var a="get"!==e.type;!1!==e.cache&&(e.cache=!0),e.cache||a||!b(e.data)||(e.data._=w()),e.headers||(e.headers={}),e.contentType&&(e.headers["Content-Type"]?delete e.contentType:e.headers["Content-Type"]=e.contentType),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"string"!=typeof e.responseType&&("string"==typeof e.dataType&&/^(text|json|xml|html)$/i.test(e.dataType)?e.responseType=e.dataType:e.responseType="text"),e.complete&&(e.always=e.complete,delete e.complete);var s=!!e.agent;return!r||B?J.apply(null,n):s||!H||o||a||/\/json/i.test(e.headers["Content-Type"])?V.apply(null,n):D.apply(null,n)}Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null==this)throw new TypeError("this is null or not defined");var r=Object(this),o=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(t=arguments[1]),n=0;n<o;){var a;n in r&&(a=r[n],e.call(t,a,n,r)),n++}});var w=function(){return 1e4*(new Date).getTime()+Math.floor(1e4*Math.random())},m=function(){var e=0;return function(){return e++}}(),g=function(e){return"number"==typeof e},v=function(e){var t=parseInt(e);return!isNaN(t)&&(("number"==typeof e||"string"==typeof e)&&t==e)},T=function(e){return"string"==typeof e},x=function(e){return"function"==typeof e},b=function(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)},C=function(e){return"[object Array]"===Object.prototype.toString.call(e)},O=function(e){return null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"function"==typeof e},j=function(e,t,n){if(b(e)){for(var r in e)if(e.hasOwnProperty(r)&&!1===(o=t(e[r],r)))break}else if(C(e))if(n)for(a=e.length-1;a>=0;a--){var o=t(e[a],a);if(!1===o)break}else for(var a=0,s=e.length;a<s&&!1!==(o=t(e[a],a));a++);else x(e.forEach)&&e.forEach(t)},E=function(e){var t=e;return b(e)?(t={},j(e,function(e,n){t[n]=E(e)})):C(e)&&(t=[],j(e,function(e){t.push(E(e))})),t},S=function(e,t){if(b(e))return e.hasOwnProperty(t);if(C(e)){var n=parseInt(t);return v(t)&&e.length>n&&n>=0}return!1},L=function(e,t,n){var r=T(t)||g(t),o=r?e[t]:e;(b(o)||C(o))&&(j(o,function(e,t){L(o,t)}),C(o)&&M(o)),r&&(e[t]=n)},M=function(e,t){if(g(t))for(j(e,function(n,r){if(!(r>=t))return!1;e.length--},!0);e.length<t;)e.push(null);else j(e,function(t,n){t===undefined&&e.length--},!0);return e},N=function(e,t,n){function r(e,t,n){b(t)&&(j(t,function(t,o){!S(e,o)||O(t)?e[o]!==t&&(e[o]=E(t)):r(e[o],t,n)}),n&&(j(e,function(n,r){S(t,r)||L(e,r)}),C(e)&&M(e)))}if(!b(e))return null;var o=Array.prototype.slice.call(arguments,1,!0===arguments[arguments.length-1]?arguments.length-1:arguments.length);return n=!0===arguments[arguments.length-1],j(o,function(t){r(e,t,n)}),e},X=function(e){if(null===e)return"null";if(e===undefined)return"undefined";var t=Object.prototype.toString.call(e);return t.substring("[object ".length,t.length-1).toLowerCase()},P=function(e){if(null==e)return"";if("array"===X(e))return JSON.stringify(e);if(O(e))return String(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(O(e[n])?String(e[n]):JSON.stringify(e[n])));return t.join("&")};r.prototype.success=r.prototype.always=r.prototype.complete=r.prototype.then=function(){var e=[].slice.call(arguments);return this.promise=this.promise.then.apply(this.promise,e),this},r.prototype.error=r.prototype["catch"]=function(){var e=[].slice.call(arguments);return this.promise=this.promise["catch"].apply(this.promise,e),this};var R=window.ActiveXObject===undefined||window.document.documentMode>8?a:function(){return a()||s()},q={},A={type:"GET",url:null,data:{},headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},responseType:"text",withCredentials:!1},J=o(function(e){var t=N({},A,e||{});e.simple&&("X-Requested-With"in e.headers||delete t.headers["X-Requested-With"]);var r=m(),o={success:e.success||arguments[1]||function(){},error:e.error||arguments[2]||function(){},always:e.always||arguments[3]||function(){}},a=R(),s=function(e,n){if(null!=s&&(4===a.readyState||n))if(delete q[r],s=undefined,a.onreadystatechange=null,n)4!==a.readyState&&a.abort();else{var c=i(a,t.responseType),u={status:a.status,statusText:a.statusText,responseText:a.responseText,readyState:a.readyState};a.status>=200&&a.status<300?o.success.call(o,c,u):o.error.call(o,c,u),o.always.call(o,c,u)}},c="string"==typeof t.type&&"get"!==t.type.toLowerCase(),u=!c&&/multipart\/form-data/i.test(t.headers["Content-Type"])?t.data:P(t.data);if(a.open(t.type,c||!u?t.url:t.url+(t.url.indexOf("?")>0?"&":"?")+u,!0),a.overrideMimeType)switch(t.responseType){case"document":case"xml":a.overrideMimeType("text/xml; charset=utf-8");break;case"text":a.overrideMimeType("text/plain; charset=utf-8");break;case"blob":a.overrideMimeType("text/plain; charset=x-user-defined")}for(var l in t.headers)t.headers.hasOwnProperty(l)&&a.setRequestHeader(l,t.headers[l]);return/^\d+$/.test(e.timeout)&&(a.timeout=e.timeout,a.ontimeout=s),t.withCredentials&&(a.withCredentials=!0),c?a.send(/application\/json/i.test(t.headers["Content-Type"])?JSON.stringify(t.data):u):a.send(""),4===a.readyState?window.setTimeout(s):a.onreadystatechange=q[r]=s,{success:n(o,"success"),error:n(o,"error"),always:n(o,"always"),abort:function(){s&&s(undefined,!0)}}});window.attachEvent&&window.attachEvent("onunload",function(){for(var e in q)q.hasOwnProperty(e)&&q[e](undefined,!0)});var k=R(),B=!!k&&"withCredentials"in k,I=/^(https?:)?\/\//i,U=/^get|post$/i,$=new RegExp("^(//|"+window.location.protocol+")","i"),W={type:"GET",url:null,data:{},responseType:"text"},D=o(function(e){if(e=N({},W,e||{}),U.test(e.type)&&I.test(e.url)&&$.test(e.url)){var t=(e.responseType||"json").toLowerCase(),r=new XDomainRequest;/^\d+$/.test(e.timeout)&&(r.timeout=e.timeout);var o={success:e.success||function(){},error:e.error||function(){},always:e.always||function(){}};r.ontimeout=function(){var e={status:{code:500,message:"timeout"}};o.error.call(o,null,e),o.always.call(o,null,e)},r.onprogress=function(){},r.onload=function(){var e={code:200,message:"success"},n={headers:{"Content-Length":r.responseText.length,"Content-Type":r.contentType},text:r.responseText,data:c(r.responseText)};if("html"===t||/text\/html/i.test(r.contentType))n.data=r.responseText;else if("json"===t||"text"!==t&&/\/json/i.test(r.contentType))try{n.data=JSON.parse(r.responseText)}catch(s){e.code=500,e.message="parser error: invalid json"}else if("xml"===t||"text"!==t&&/\/xml/i.test(r.contentType)){var a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";try{a.loadXML(r.responseText)}catch(s){a=undefined}a&&a.documentElement&&!a.getElementsByTagName("parsererror").length||(e.code=500,e.message="parser error: invalid xml"),n.data=a}n.status=e,e.code>=200&&e.code<300?o.success.call(o,n.data,n):o.error.call(o,n.data,n),o.always.call(o,n.data,n)},r.onerror=function(){var e=[r.responseText,{status:{code:500,message:"error"},text:r.responseText}];o.error.apply(o,e),o.always.apply(o,e)};var a="string"==typeof e.type&&"get"!==e.type.toLowerCase(),s=P(e.data);return r.open(e.type,a||!s?e.url:e.url+(e.url.indexOf("?")>0?"&":"?")+s),window.setTimeout(function(){r.send(a?s:"")},0),{success:n(o,"success"),error:n(o,"error"),always:n(o,"always"),abort:function(){r.abort()}}}}),H=!!window.XDomainRequest,F=o(function(e,t){var r="jsonp_"+w();window[r]=t||e.callback||e.complete;var o=window.document.getElementsByTagName("script")[0],a=window.document.createElement("script");a.src=e.url+(e.url.indexOf("?")>=0?"&":"?")+P(e.data)+"&callback="+r,o.parentNode.insertBefore(a,o),a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState)){a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),a=null,window[r]=undefined;try{delete window[r]}catch(e){}}};var s=n(window,r);return{success:s,complete:s,error:function(){}}}),G={},_={},z={},K={},Q={};!function(e,t,n){n=n||window,window.addEventListener?n.addEventListener(e,t,!1):n.attachEvent("on"+e,t)}("message",function(e){var t;try{t=JSON.parse(e.data)}catch(r){}if(t)switch(t.type){case"iframe-agent-ready":K[t.origin]=!0;var n=window.document.getElementById(d(t.origin));Q[t.origin]&&(Q[t.origin].forEach(function(e){n.contentWindow.postMessage(e,t.origin)}),Q[t.origin].length=0),delete Q[t.origin];break;case"iframe-agent-response":null!=t.id&&_[t.origin][t.id]&&("success"===t.message?_[t.origin][t.id].success.apply(null,t.data):"error"===t.message&&_[t.origin][t.id].error.apply(null,t.data),_[t.origin][t.id].always&&_[t.origin][t.id].always.apply(null,t.data),delete _[t.origin][t.id])}});var V=o(function(t){t.url=e(t.url);var r=u(t.url);t.agentPageUrl&&(t.agentPageUrl=e(t.agentPageUrl),z[r]=t.agentPageUrl);var o={success:t.success||arguments[1]||function(){},error:t.error||arguments[2]||function(){},always:t.always||arguments[3]||function(){}},a=w();return _[r]||(_[r]={}),_[r][a]=o,y(r,f(r),a,t),{success:n(o,"success"),error:n(o,"error"),always:n(o,"always")}});return h.defaults={},"function"==typeof Promise&&(h.defaults.promise=Promise),h});
