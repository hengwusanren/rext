!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.rexter=t()}(this,function(){"use strict";function e(e){var t=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,n=t.exec(window.location.href.toLowerCase())||[],r=t.exec(e.toLowerCase());return!(!r||r[1]===n[1]&&r[2]===n[2]&&(r[3]||("http:"===r[1]?"80":"443"))===(n[3]||("http:"===n[1]?"80":"443")))}function t(e,t){return function(n){var r=e[t];return e[t]=function(){var e=[].slice.call(arguments);r&&r.apply(this,e),n&&n.apply(this,e)},this}}function n(e,t){this.promise=new e(t)}function r(e){return function(t){var r=[].slice.call(arguments),o=e.apply(null,r);return t.promise?new n(t.promise,function(e,t){o.success(function(t){e(t)}),o.error(function(e){t(e)})}):o}}function o(){try{return new window.XMLHttpRequest}catch(e){}}function a(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}function s(e,t){var n;if("blob"===t)return"function"==typeof Blob?e.response:e.responseText;if("text"!==e.responseType&&""!==e.responseType)return e.response;try{n=JSON.parse(e.responseText)}catch(r){n=e.responseText}return n}function i(e){var t;try{t=JSON.parse(e)}catch(n){t=e}return t}function c(e){var t=window.document.createElement("a");return t.href=e,t.protocol+"//"+t.host}function u(e){return F[e]===undefined&&(F[e]=h()),F[e]}function p(e){return _[e]===undefined&&(_[e]=e+"/iframe-agent.html"),_[e]}function l(e){return"iframe-agent-"+u(e)}function d(e){var t=l(e),n=window.document.getElementById(t);n||((n=window.document.createElement("iframe")).id=t,n.style.display="none",window.document.body.appendChild(n));var r=p(e);return n.src!==r&&(n.src=r),n}function f(e,t,n,r){var o={type:"iframe-agent-request",origin:e,id:n,data:r};z[e]?t.contentWindow.postMessage(JSON.stringify(o),e):(K[e]||(K[e]=[]),K[e].push(JSON.stringify(o)))}function y(t){var n=[].slice.call(arguments);if(t.promise&&"function"!=typeof t.promise&&(t.promise=y.defaults.promise),"string"==typeof t.dataType&&(t.dataType=t.dataType.toLowerCase()),"string"==typeof t.responseType&&(t.responseType=t.responseType.toLowerCase()),"string"==typeof t.method&&(t.method=t.method.toLowerCase()),"string"==typeof t.type&&(t.type=t.type.toLowerCase()),!!t.jsonp||"jsonp"===t.dataType||"jsonp"===t.responseType)return $.apply(null,n);var r=e(t.url),o=!!t.withCredentials||t.xhrFields&&!!t.xhrFields.withCredentials;t.withCredentials=o,t.type||"string"!=typeof t.method||(t.type=t.method),"string"!=typeof t.type&&(t.type="get"),t.type=t.type.toLowerCase();var a="get"!==t.type;t.headers||(t.headers={}),t.contentType&&(t.headers["Content-Type"]?delete t.contentType:t.headers["Content-Type"]=t.contentType),t.headers["Content-Type"]||(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"string"!=typeof t.responseType&&("string"==typeof t.dataType&&/^(text|json|xml|html)$/i.test(t.dataType)?t.responseType=t.dataType:t.responseType="text"),t.complete&&(t.always=t.complete,delete t.complete);var s=!!t.agent;return!r||A?k.apply(null,n):s||!W||o||a||/\/json/i.test(t.headers["Content-Type"])?Q.apply(null,n):U.apply(null,n)}Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null==this)throw new TypeError("this is null or not defined");var r=Object(this),o=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(t=arguments[1]),n=0;n<o;){var a;n in r&&(a=r[n],e.call(t,a,n,r)),n++}});var h=function(){return 1e4*(new Date).getTime()+Math.floor(1e4*Math.random())},w=function(){var e=0;return function(){return e++}}(),m=function(e){return"number"==typeof e},g=function(e){var t=parseInt(e);return!isNaN(t)&&(("number"==typeof e||"string"==typeof e)&&t==e)},v=function(e){return"string"==typeof e},T=function(e){return"function"==typeof e},x=function(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)},b=function(e){return"[object Array]"===Object.prototype.toString.call(e)},C=function(e){return null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"function"==typeof e},O=function(e,t,n){if(x(e)){for(var r in e)if(e.hasOwnProperty(r)&&!1===(o=t(e[r],r)))break}else if(b(e))if(n)for(a=e.length-1;a>=0;a--){var o=t(e[a],a);if(!1===o)break}else for(var a=0,s=e.length;a<s&&!1!==(o=t(e[a],a));a++);else T(e.forEach)&&e.forEach(t)},j=function(e){var t=e;return x(e)?(t={},O(e,function(e,n){t[n]=j(e)})):b(e)&&(t=[],O(e,function(e){t.push(j(e))})),t},E=function(e,t){if(x(e))return e.hasOwnProperty(t);if(b(e)){var n=parseInt(t);return g(t)&&e.length>n&&n>=0}return!1},L=function(e,t,n){var r=v(t)||m(t),o=r?e[t]:e;(x(o)||b(o))&&(O(o,function(e,t){L(o,t)}),b(o)&&S(o)),r&&(e[t]=n)},S=function(e,t){if(m(t))for(O(e,function(n,r){if(!(r>=t))return!1;e.length--},!0);e.length<t;)e.push(null);else O(e,function(t,n){t===undefined&&e.length--},!0);return e},M=function(e,t,n){function r(e,t,n){x(t)&&(O(t,function(t,o){!E(e,o)||C(t)?e[o]!==t&&(e[o]=j(t)):r(e[o],t,n)}),n&&(O(e,function(n,r){E(t,r)||L(e,r)}),b(e)&&S(e)))}if(!x(e))return null;var o=Array.prototype.slice.call(arguments,1,!0===arguments[arguments.length-1]?arguments.length-1:arguments.length);return n=!0===arguments[arguments.length-1],O(o,function(t){r(e,t,n)}),e},N=function(e){if(null===e)return"null";if(e===undefined)return"undefined";var t=Object.prototype.toString.call(e);return t.substring("[object ".length,t.length-1).toLowerCase()},X=function(e){if(null==e)return"";if("array"===N(e))return JSON.stringify(e);if(C(e))return String(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(C(e[n])?String(e[n]):JSON.stringify(e[n])));return t.join("&")};n.prototype.success=n.prototype.always=n.prototype.complete=n.prototype.then=function(){var e=[].slice.call(arguments);return this.promise=this.promise.then.apply(this.promise,e),this},n.prototype.error=n.prototype["catch"]=function(){var e=[].slice.call(arguments);return this.promise=this.promise["catch"].apply(this.promise,e),this};var P=window.ActiveXObject===undefined||window.document.documentMode>8?o:function(){return o()||a()},J={},R={type:"GET",url:null,data:{},headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},responseType:"text",withCredentials:!1},k=r(function(e){var n=M({},R,e||{}),r=w(),o={success:e.success||arguments[1]||function(){},error:e.error||arguments[2]||function(){},always:e.always||arguments[3]||function(){}},a=P(),i=function(e,t){if(null!=i&&(4===a.readyState||t))if(delete J[r],i=undefined,a.onreadystatechange=null,t)4!==a.readyState&&a.abort();else{var c=s(a,n.responseType);a.status>=200&&a.status<300?o.success.call(o,c,a):o.error.call(o,c,a),o.always.call(o,c,a)}},c="string"==typeof n.type&&"get"!==n.type.toLowerCase(),u=!c&&/multipart\/form-data/i.test(n.headers["Content-Type"])?n.data:X(n.data);if(a.open(n.type,c||!u?n.url:n.url+(n.url.indexOf("?")>0?"&":"?")+u,!0),a.responseType=n.responseType,a.overrideMimeType)switch(n.responseType){case"document":case"xml":a.overrideMimeType("text/xml; charset=utf-8");break;case"text":a.overrideMimeType("text/plain; charset=utf-8");break;case"blob":a.overrideMimeType("text/plain; charset=x-user-defined")}for(var p in n.headers)n.headers.hasOwnProperty(p)&&a.setRequestHeader(p,n.headers[p]);return n.withCredentials&&(a.withCredentials=!0),c?a.send(/application\/json/i.test(n.headers["Content-Type"])?JSON.stringify(n.data):u):a.send(""),4===a.readyState?window.setTimeout(i):a.onreadystatechange=J[r]=i,{success:t(o,"success"),error:t(o,"error"),always:t(o,"always"),abort:function(){i&&i(undefined,!0)}}});window.attachEvent&&window.attachEvent("onunload",function(){for(var e in J)J.hasOwnProperty(e)&&J[e](undefined,!0)});var q=P(),A=!!q&&"withCredentials"in q,B=/^(https?:)?\/\//i,I=/^get|post$/i,D=new RegExp("^(//|"+window.location.protocol+")","i"),H={type:"GET",url:null,data:{},responseType:"text"},U=r(function(e){if(e=M({},H,e||{}),I.test(e.type)&&B.test(e.url)&&D.test(e.url)){var n=(e.responseType||"json").toLowerCase(),r=new XDomainRequest;/^\d+$/.test(e.timeout)&&(r.timeout=e.timeout);var o={success:e.success||function(){},error:e.error||function(){},always:e.always||function(){}};r.ontimeout=function(){var e={status:{code:500,message:"timeout"}};o.error.call(o,null,e),o.always.call(o,null,e)},r.onprogress=function(){},r.onload=function(){var e={code:200,message:"success"},t={headers:{"Content-Length":r.responseText.length,"Content-Type":r.contentType},text:r.responseText,data:i(r.responseText)};if("html"===n||/text\/html/i.test(r.contentType))t.data=r.responseText;else if("json"===n||"text"!==n&&/\/json/i.test(r.contentType))try{t.data=JSON.parse(r.responseText)}catch(s){e.code=500,e.message="parser error: invalid json"}else if("xml"===n||"text"!==n&&/\/xml/i.test(r.contentType)){var a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";try{a.loadXML(r.responseText)}catch(s){a=undefined}a&&a.documentElement&&!a.getElementsByTagName("parsererror").length||(e.code=500,e.message="parser error: invalid xml"),t.data=a}t.status=e,e.code>=200&&e.code<300?o.success.call(o,t.data,t):o.error.call(o,t.data,t),o.always.call(o,t.data,t)},r.onerror=function(){var e=[r.responseText,{status:{code:500,message:"error"},text:r.responseText}];o.error.apply(o,e),o.always.apply(o,e)};var a="string"==typeof e.type&&"get"!==e.type.toLowerCase(),s=X(e.data);return r.open(e.type,a||!s?e.url:e.url+(e.url.indexOf("?")>0?"&":"?")+s),window.setTimeout(function(){r.send(a?s:"")},0),{success:t(o,"success"),error:t(o,"error"),always:t(o,"always"),abort:function(){r.abort()}}}}),W=!!window.XDomainRequest,$=r(function(e,n){var r="jsonp_"+h();window[r]=n||e.callback||e.complete;var o=window.document.getElementsByTagName("script")[0],a=window.document.createElement("script");a.src=e.url+(e.url.indexOf("?")>=0?"&":"?")+X(e.data)+"&callback="+r,o.parentNode.insertBefore(a,o),a.onload=a.onreadystatechange=function(){a.readyState&&!/loaded|complete/.test(a.readyState)||(a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),a=null)};var s=t(window,r);return{success:s,complete:s,error:function(){}}}),F={},G={},_={},z={},K={};!function(e,t,n){n=n||window,window.addEventListener?n.addEventListener(e,t,!1):n.attachEvent("on"+e,t)}("message",function(e){var t;try{t=JSON.parse(e.data)}catch(r){}if(t)switch(t.type){case"iframe-agent-ready":z[t.origin]=!0;var n=window.document.getElementById(l(t.origin));K[t.origin]&&(K[t.origin].forEach(function(e){n.contentWindow.postMessage(e,t.origin)}),K[t.origin].length=0),delete K[t.origin];break;case"iframe-agent-response":null!=t.id&&G[t.origin][t.id]&&("success"===t.message?G[t.origin][t.id].success.apply(null,t.data):"error"===t.message&&G[t.origin][t.id].error.apply(null,t.data),G[t.origin][t.id].always&&G[t.origin][t.id].always.apply(null,t.data),delete G[t.origin][t.id])}});var Q=r(function(e){var n=c(e.url);e.agentPageUrl&&(_[n]=e.agentPageUrl);var r={success:e.success||arguments[1]||function(){},error:e.error||arguments[2]||function(){},always:e.always||arguments[3]||function(){}},o=h();return G[n]||(G[n]={}),G[n][o]=r,f(n,d(n),o,e),{success:t(r,"success"),error:t(r,"error"),always:t(r,"always")}});return y.defaults={},"function"==typeof Promise&&(y.defaults.promise=Promise),y});
